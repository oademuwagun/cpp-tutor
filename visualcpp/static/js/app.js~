function App(app_data){
	this.FRAME_CONTAINER = "#frame-container";
	this.GLOBAL_VARIABLE_CONTAINER = "#global-variable-container";

	this.FRAME_CONTAINER_TEMPLATE = "#frame-container-template";
	this.GLOBAL_VARIABLE_CONTAINER_TEMPLATE = "#global-variable-container-template";
	this.FRAME_TEMPLATE = "#frame-template";
	this.VARIABLE_TEMPLATE = "#variable-template";

	this.VISUALIZATION_PANEL = "#visualization-panel";

	this.STEP_FORWARD_BUTTON = "#step-forward-button";
	this.STEP_BACKWARD_BUTTON = "#step-backward-button";
	this.CURRENT_STEP_INDICATOR = "#current-step";

	this.current_state = 0;
	this.data = app_data;
	this.no_of_steps = app_data.length;

	this.initialize_panel = function(){
		$(this.VISUALIZATION_PANEL).html("")
		$(this.VISUALIZATION_PANEL).append( $(this.GLOBAL_VARIABLE_CONTAINER_TEMPLATE).html() );
		$(this.VISUALIZATION_PANEL).append( $(this.FRAME_CONTAINER_TEMPLATE).html() );
	};

	this.generate_frame_html = function(frame_name){
		var template = Handlebars.compile( $(this.FRAME_TEMPLATE).html() );
		return template( {name: frame_name} );
	};

	this.generate_variable_html = function(variable_name, variable_value){
		var template = Handlebars.compile( $(this.VARIABLE_TEMPLATE).html() );
		return template( {name: variable_name, value: variable_value} );
	};

	this.add_all_global_variables = function(){
		var all_globals = this.data[this.current_state]["global"];
		var global_variable_container= $(this.GLOBAL_VARIABLE_CONTAINER);
		for(global_name in all_globals){
			global_variable_container.append(this.generate_variable_html(global_name, all_globals[global_name]));
		}	
	};

	this.add_all_frames = function(){
		var all_frames_data = this.data[this.current_state]["data"]
		var frame_container= $(this.FRAME_CONTAINER);

		for(frame_name in all_frames_data){
			var frame_html = $(this.generate_frame_html(frame_name));
			var frame = all_frames_data[frame_name];

			//Get all the variables in each frame
			for(variable_name in frame){
				var frame_variable_html = this.generate_variable_html(variable_name, frame[variable_name])
				frame_html.append(frame_variable_html)
			}
			frame_container.append(frame_html);
		}	
	};

	this.change_step_indicator = function(){
		$(this.CURRENT_STEP_INDICATOR).html(this.current_state+1);
	};

	this.change_state = function(state_num){
		if(state_num <= this.no_of_steps-1 || state_num >= 0){
			this.current_state = state_num;
			this.start(); //restart
			this.change_step_indicator();
		}
	};

	this.step_forward = function(){
		this.change_state(this.current_state+1);
	};

	this.step_backward = function(){
		this.change_state(this.current_state-1);
	};

	this.start = function(){
		this.initialize_panel();
		this.add_all_frames();
		this.add_all_global_variables();
		$(this.VISUALIZATION_PANEL).show();
	}

};


if($("#visualization-result").length > 0){ 
	var result_json = $("#visualization-result").html();
	var app_data = eval(result_json);
	var newApp = new App(app_data);
	newApp.start();

	$(newApp.STEP_FORWARD_BUTTON).click(function(e){
		e.stopPropagation();
		e.preventDefault();
		newApp.step_forward()
	});

	$(newApp.STEP_BACKWARD_BUTTON).click(function(e){
		e.stopPropagation();
		e.preventDefault();
		newApp.step_backward()
	});
}


